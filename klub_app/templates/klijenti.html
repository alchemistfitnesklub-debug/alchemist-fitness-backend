{% extends 'base.html' %}
{% load static %}

{% block title %}Klijenti - Fitness Klub{% endblock %}

{% block extra_head %}
<style>
/* ========================================
   KLIJENTI - MODERNIZOVAN DIZAJN (FIXED)
   ======================================== */

/* KARTICE STATISTIKE */
.stats-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.05));
    border-radius: 15px;
    padding: 25px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    transition: transform 0.3s, box-shadow 0.3s;
    text-align: center;
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
}

.stat-card i {
    font-size: 2.5em;
    margin-bottom: 15px;
    opacity: 0.9;
}

.stat-card h3 {
    font-size: 2em;
    margin: 10px 0;
    font-weight: bold;
}

.stat-card p {
    font-size: 0.95em;
    opacity: 0.85;
    margin: 5px 0;
}

.stat-card.blue { color: #4facfe; }
.stat-card.purple { color: #667eea; }
.stat-card.orange { color: #f093fb; }
.stat-card.green { color: #43e97b; }

body.dark-theme .stat-card {
    background: linear-gradient(135deg, rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.2));
    border: 1px solid rgba(255, 255, 255, 0.1);
}

/* SECTION KARTICE */
.section-card {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 15px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    backdrop-filter: blur(10px);
    padding: 25px;
    margin: 20px 0;
    border: 1px solid rgba(255, 255, 255, 0.2);
}

body.dark-theme .section-card {
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.section-header {
    display: flex;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid rgba(255, 255, 255, 0.2);
}

.section-header i {
    font-size: 1.8em;
    margin-right: 15px;
    color: #00bfff;
}

.section-header h2 {
    margin: 0;
    font-size: 1.5em;
}

/* PRETRAGA SA AUTOCOMPLETE */
.search-container {
    margin-bottom: 30px;
    position: relative;
}

.search-container input {
    width: 100%;
    padding: 15px 20px;
    border-radius: 12px;
    border: 2px solid rgba(255, 255, 255, 0.2);
    background: rgba(255, 255, 255, 0.9);
    color: #333;
    font-size: 1em;
    transition: all 0.3s;
}

body.dark-theme .search-container input {
    background: rgba(0, 0, 0, 0.5);
    color: #fff;
    border: 2px solid rgba(255, 255, 255, 0.3);
}

.search-container input:focus {
    outline: none;
    border-color: #00bfff;
    box-shadow: 0 0 20px rgba(0, 191, 255, 0.3);
}

/* AUTOCOMPLETE REZULTATI */
#autocomplete-results {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    max-height: 400px;
    overflow-y: auto;
    background: white;
    border: 2px solid #00bfff;
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    z-index: 1000;
    display: none;
    margin-top: 5px;
}

body.dark-theme #autocomplete-results {
    background: #1a1a1a;
    border-color: #00bfff;
}

.autocomplete-item {
    padding: 15px 20px;
    cursor: pointer;
    transition: all 0.2s;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
}

body.dark-theme .autocomplete-item {
    border-bottom-color: rgba(255, 255, 255, 0.1);
}

.autocomplete-item:hover {
    background: linear-gradient(135deg, #00bfff, #0099cc);
    color: white !important;
}

.autocomplete-item:last-child {
    border-bottom: none;
}

.autocomplete-name {
    font-weight: bold;
    font-size: 1.1em;
    margin-bottom: 5px;
    color: #333; /* Tamno za light theme */
}

body.dark-theme .autocomplete-name {
    color: #fff; /* Belo za dark theme */
}

.autocomplete-details {
    font-size: 0.9em;
    opacity: 0.8;
    display: flex;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 10px;
    color: #333; /* Tamno za light theme */
}

body.dark-theme .autocomplete-details {
    color: #fff; /* Belo za dark theme */
}

.autocomplete-krediti {
    color: #00bfff;
    font-weight: 600;
}

body.dark-theme .autocomplete-item:hover .autocomplete-krediti {
    color: white;
}

/* AKCIONI DUGMIƒÜI */
.actions-row {
    display: flex;
    gap: 15px;
    margin-bottom: 30px;
    flex-wrap: wrap;
}

.btn-primary, .btn-success, .btn-warning {
    background: linear-gradient(135deg, #00bfff, #0099cc);
    color: white;
    border: none;
    padding: 12px 25px;
    border-radius: 10px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 4px 15px rgba(0, 191, 255, 0.3);
    font-size: 1em;
    text-decoration: none;
    display: inline-block;
}

.btn-success {
    background: linear-gradient(135deg, #43e97b, #38d278);
    box-shadow: 0 4px 15px rgba(67, 233, 123, 0.3);
}

.btn-warning {
    background: linear-gradient(135deg, #f093fb, #f5576c);
    box-shadow: 0 4px 15px rgba(240, 147, 251, 0.3);
}

.btn-primary:hover, .btn-success:hover, .btn-warning:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 191, 255, 0.4);
}

/* FORME (skrivene) */
.hidden-form {
    display: none;
    padding: 20px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    margin-bottom: 20px;
    border: 1px solid rgba(255, 255, 255, 0.2);
}

body.dark-theme .hidden-form {
    background: rgba(0, 0, 0, 0.3);
}

.hidden-form input[type="text"],
.hidden-form input[type="email"],
.hidden-form input[type="date"],
.hidden-form input[type="file"],
.hidden-form select {
    width: 100%;
    padding: 10px 15px;
    margin: 8px 0;
    border-radius: 8px;
    border: 2px solid rgba(255, 255, 255, 0.2);
    background: rgba(255, 255, 255, 0.9);
    color: #333;
}

body.dark-theme .hidden-form input,
body.dark-theme .hidden-form select {
    background: rgba(0, 0, 0, 0.5);
    color: #fff;
}

/* GRID PRIKAZ KLIJENATA */
.clients-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.client-card {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.05));
    border-radius: 15px;
    padding: 20px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    transition: all 0.3s;
    text-align: center;
    cursor: pointer;
}

body.dark-theme .client-card {
    background: linear-gradient(135deg, rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.2));
}

.client-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 12px 40px rgba(0, 191, 255, 0.4);
    border-color: #00bfff;
}

.client-avatar {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    margin: 0 auto 15px;
    border: 4px solid rgba(255, 255, 255, 0.3);
    object-fit: cover;
    background: linear-gradient(135deg, #4facfe, #00f2fe);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 3em;
    color: white;
}

.client-name {
    font-size: 1.2em;
    font-weight: bold;
    margin: 10px 0;
    color: #00bfff;
}

.client-info {
    font-size: 0.9em;
    opacity: 0.8;
    margin: 5px 0;
}

.client-status {
    display: inline-block;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.85em;
    font-weight: 600;
    margin-top: 10px;
}

.status-active {
    background: linear-gradient(135deg, #43e97b, #38d278);
    color: white;
}

.status-expiring {
    background: linear-gradient(135deg, #ffa500, #ff8c00);
    color: white;
}

.status-expired {
    background: linear-gradient(135deg, #ff4444, #cc0000);
    color: white;
}

.client-credits {
    margin-top: 15px;
    padding: 10px;
    background: rgba(0, 191, 255, 0.1);
    border-radius: 10px;
    border: 1px solid rgba(0, 191, 255, 0.3);
}

.client-credits strong {
    color: #00bfff;
    font-size: 1.2em;
}

/* FILTER TABS */
.filter-tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.filter-tab {
    padding: 10px 20px;
    background: rgba(255, 255, 255, 0.1);
    border: 2px solid rgba(255, 255, 255, 0.2);
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.3s;
    font-weight: 600;
}

.filter-tab:hover,
.filter-tab.active {
    background: linear-gradient(135deg, #00bfff, #0099cc);
    border-color: #00bfff;
    color: white;
}

/* ANIMACIJE */
@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.client-card {
    animation: slideIn 0.5s ease-out;
}

.client-card:nth-child(1) { animation-delay: 0.05s; }
.client-card:nth-child(2) { animation-delay: 0.1s; }
.client-card:nth-child(3) { animation-delay: 0.15s; }
.client-card:nth-child(4) { animation-delay: 0.2s; }

/* RESPONSIVE */
@media (max-width: 768px) {
    .stats-row {
        grid-template-columns: 1fr;
    }
    
    .clients-grid {
        grid-template-columns: 1fr;
    }
    
    .actions-row {
        flex-direction: column;
    }
    
    .actions-row button,
    .actions-row a {
        width: 100%;
    }
}
</style>
{% endblock %}

{% block content %}
<div style="max-width: 1400px; margin: 0 auto;">
    
    <!-- NASLOV -->
    <div style="text-align: center; margin-bottom: 30px;">
        <h1 style="font-size: 2.5em; margin-bottom: 10px;">
            <i class="fas fa-users"></i> KLIJENTI - UPRAVLJANJE
        </h1>
        <p style="opacity: 0.8; font-size: 1.1em;">Trenutno stanje: {% now "d.m.Y H:i" %}</p>
    </div>

    <!-- STATISTIKA DASHBOARD -->
    <div class="stats-row">
        <div class="stat-card blue">
            <i class="fas fa-users"></i>
            <h3>{{ clanovi|length }}</h3>
            <p>Ukupno klijenata</p>
        </div>
        
        <div class="stat-card green">
            <i class="fas fa-check-circle"></i>
            <h3 id="active-count">0</h3>
            <p>Aktivnih ƒçlanarina</p>
        </div>
        
        <div class="stat-card orange">
            <i class="fas fa-exclamation-triangle"></i>
            <h3 id="expiring-count">0</h3>
            <p>Istiƒçe uskoro (7 dana)</p>
        </div>
        
        <div class="stat-card purple">
            <i class="fas fa-user-plus"></i>
            <h3 id="new-count">0</h3>
            <p>Neaktivnih</p>
        </div>
    </div>

    <!-- PRETRAGA SA AUTOCOMPLETE -->
    <div class="section-card">
        <div class="section-header">
            <i class="fas fa-search"></i>
            <h2>Pretraga klijenata</h2>
        </div>
        <div class="search-container">
            <input type="text" 
                   id="clanSearch" 
                   placeholder="üîç Poƒçni kucati ime, prezime, telefon ili email..." 
                   autocomplete="off">
            <div id="autocomplete-results"></div>
        </div>
    </div>

    <!-- AKCIONI DUGMIƒÜI -->
    <div class="actions-row">
        <a href="{% url 'klijenti' %}?export=excel" class="btn-primary">
            <i class="fas fa-file-excel"></i> Eksportuj u Excel
        </a>
        <button class="btn-success" onclick="toggleForm('add-client-form')">
            <i class="fas fa-user-plus"></i> Dodaj novog klijenta
        </button>
        <button class="btn-warning" onclick="toggleForm('import-excel-form')">
            <i class="fas fa-file-upload"></i> Uvezi iz Excel-a
        </button>
    </div>

    <!-- FORMA ZA DODAVANJE KLIJENTA -->
    <div id="add-client-form" class="hidden-form">
        <h3 style="margin-bottom: 15px;">
            <i class="fas fa-user-plus"></i> Dodaj novog klijenta
        </h3>
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            {{ form.as_p }}
            <button type="submit" class="btn-success">
                <i class="fas fa-check"></i> Dodaj klijenta
            </button>
        </form>
    </div>

    <!-- FORMA ZA UVOZ EXCEL-A -->
    <div id="import-excel-form" class="hidden-form">
        <h3 style="margin-bottom: 15px;">
            <i class="fas fa-file-upload"></i> Uvezi klijente iz Excel-a
        </h3>
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="file" 
                   name="excel_file" 
                   accept=".xlsx,.xls" 
                   required
                   style="margin-bottom: 15px;">
            <button type="submit" class="btn-warning">
                <i class="fas fa-upload"></i> Uvezi
            </button>
        </form>
    </div>

    <!-- FILTER TABS -->
    <div class="filter-tabs">
        <div class="filter-tab active" onclick="filterClients('all')">
            <i class="fas fa-users"></i> Svi klijenti
        </div>
        <div class="filter-tab" onclick="filterClients('active')">
            <i class="fas fa-check-circle"></i> Aktivni
        </div>
        <div class="filter-tab" onclick="filterClients('expiring')">
            <i class="fas fa-exclamation-triangle"></i> Istiƒçu uskoro
        </div>
        <div class="filter-tab" onclick="filterClients('expired')">
            <i class="fas fa-times-circle"></i> Neaktivni
        </div>
    </div>

    <!-- GRID PRIKAZ KLIJENATA -->
    <div class="clients-grid" id="clients-grid">
        {% for clan in clanovi %}
        {% with uplata=clan.uplata_set.all|dictsortreversed:"do_datum"|first %}
        <div class="client-card" 
             onclick="window.location.href='{% url 'profil' clan.id %}'" 
             data-status="{% if uplata %}{% now 'Y-m-d' as danas %}{% if uplata.do_datum|date:'Y-m-d' >= danas %}active{% else %}expired{% endif %}{% else %}expired{% endif %}"
             data-expiry="{% if uplata %}{{ uplata.do_datum|date:'Y-m-d' }}{% endif %}">
            
            <div class="client-avatar">
                {% if clan.slika %}
                    <img src="{{ clan.slika.url }}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                {% else %}
                    <i class="fas fa-user"></i>
                {% endif %}
            </div>
            
            <div class="client-name">{{ clan.ime_prezime }}</div>
            
            <div class="client-info">
                <i class="fas fa-phone"></i> {{ clan.telefon|default:"N/A" }}
            </div>
            
            <div class="client-info">
                <i class="fas fa-envelope"></i> {{ clan.email|default:"N/A" }}
            </div>
            
            <div class="client-info">
                <i class="fas fa-birthday-cake"></i> 
                {% if clan.datum_rodjenja %}
                    {{ clan.datum_rodjenja|date:"d.m.Y" }}
                {% else %}
                    N/A
                {% endif %}
            </div>
            
            <!-- STATUS ƒåLANARINE -->
            {% if uplata %}
                {% now "Y-m-d" as danas %}
                {% if uplata.do_datum|date:"Y-m-d" >= danas %}
                    <span class="client-status status-active">
                        <i class="fas fa-check-circle"></i> Aktivna do {{ uplata.do_datum|date:"d.m.Y" }}
                    </span>
                {% else %}
                    <span class="client-status status-expired">
                        <i class="fas fa-times-circle"></i> Istekla
                    </span>
                {% endif %}
            {% else %}
                <span class="client-status status-expired">
                    <i class="fas fa-info-circle"></i> Nema ƒçlanarine
                </span>
            {% endif %}
            
            <!-- KREDITI -->
            <div class="client-credits">
                <strong>{{ clan.krediti_voda|floatformat:2 }} ‚Ç¨</strong>
                <div style="font-size: 0.85em; opacity: 0.7; margin-top: 5px;">Krediti za vodu</div>
            </div>
        </div>
        {% endwith %}
        {% empty %}
        <div style="text-align: center; padding: 50px; grid-column: 1 / -1;">
            <i class="fas fa-users" style="font-size: 4em; opacity: 0.3; margin-bottom: 20px;"></i>
            <p style="font-size: 1.2em; opacity: 0.7;">Nema klijenata.</p>
        </div>
        {% endfor %}
    </div>

</div>

<script>
// AUTOCOMPLETE PRETRAGA
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('clanSearch');
    const resultsDiv = document.getElementById('autocomplete-results');
    let debounceTimer;

    searchInput.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        const q = this.value.trim();
        
        if (q.length < 2) {
            resultsDiv.innerHTML = '';
            resultsDiv.style.display = 'none';
            return;
        }

        debounceTimer = setTimeout(() => {
            fetch(`/klijenti/json/clanovi/?q=${encodeURIComponent(q)}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    resultsDiv.innerHTML = '';
                    
                    if (data.length === 0) {
                        resultsDiv.innerHTML = '<div class="autocomplete-item" style="text-align: center; cursor: default;">Nema rezultata</div>';
                        resultsDiv.style.display = 'block';
                        return;
                    }

                    data.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'autocomplete-item';
                        
                        div.innerHTML = `
                            <div class="autocomplete-name">${item.ime_prezime}</div>
                            <div class="autocomplete-details">
                                <span>üìû ${item.telefon || 'N/A'}</span>
                                <span>üìß ${item.email || 'N/A'}</span>
                                <span class="autocomplete-krediti">üí∞ ${parseFloat(item.krediti_voda).toFixed(2)} ‚Ç¨</span>
                            </div>
                        `;
                        
                        div.onclick = () => {
                            window.location.href = `/profil/${item.id}/`;
                        };
                        
                        resultsDiv.appendChild(div);
                    });
                    
                    resultsDiv.style.display = 'block';
                })
                .catch(error => {
                    console.error('Gre≈°ka pri pretrazi:', error);
                    resultsDiv.innerHTML = '<div class="autocomplete-item" style="text-align: center; cursor: default; color: #ff4444;">Gre≈°ka: autocomplete endpoint ne postoji</div>';
                    resultsDiv.style.display = 'block';
                });
        }, 300);
    });

    // Zatvori rezultate kada klikne≈° van
    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !resultsDiv.contains(e.target)) {
            resultsDiv.style.display = 'none';
        }
    });
    
    // Izraƒçunaj statistiku
    calculateStats();
});

// TOGGLE FORME
function toggleForm(formId) {
    const form = document.getElementById(formId);
    form.style.display = (form.style.display === 'none' || form.style.display === '') ? 'block' : 'none';
}

// FILTER KLIJENATA
function filterClients(filter) {
    const cards = document.querySelectorAll('.client-card');
    const tabs = document.querySelectorAll('.filter-tab');
    
    // Update active tab
    tabs.forEach(tab => tab.classList.remove('active'));
    event.target.closest('.filter-tab').classList.add('active');
    
    const danas = new Date();
    const za7Dana = new Date();
    za7Dana.setDate(za7Dana.getDate() + 7);
    
    cards.forEach(card => {
        const status = card.dataset.status;
        const expiryDateStr = card.dataset.expiry;
        
        let show = false;
        
        if (filter === 'all') {
            show = true;
        } else if (filter === 'active' && status === 'active') {
            show = true;
        } else if (filter === 'expiring') {
            if (status === 'active' && expiryDateStr) {
                const expiryDate = new Date(expiryDateStr);
                if (expiryDate >= danas && expiryDate <= za7Dana) {
                    show = true;
                }
            }
        } else if (filter === 'expired' && status === 'expired') {
            show = true;
        }
        
        card.style.display = show ? 'block' : 'none';
    });
}

// IZRAƒåUNAJ STATISTIKU
function calculateStats() {
    const cards = document.querySelectorAll('.client-card');
    let activeCount = 0;
    let expiringCount = 0;
    let expiredCount = 0;
    
    const danas = new Date();
    const za7Dana = new Date();
    za7Dana.setDate(za7Dana.getDate() + 7);
    
    cards.forEach(card => {
        const status = card.dataset.status;
        const expiryDateStr = card.dataset.expiry;
        
        if (status === 'active') {
            activeCount++;
            
            // Proveri da li istiƒçe uskoro (7 dana)
            if (expiryDateStr) {
                const expiryDate = new Date(expiryDateStr);
                if (expiryDate >= danas && expiryDate <= za7Dana) {
                    expiringCount++;
                }
            }
        } else if (status === 'expired') {
            expiredCount++;
        }
    });
    
    document.getElementById('active-count').textContent = activeCount;
    document.getElementById('expiring-count').textContent = expiringCount;
    document.getElementById('new-count').textContent = expiredCount;
}
</script>

{% endblock %}
