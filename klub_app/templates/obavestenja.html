{% extends "base.html" %}
{% load static %}

{% block content %}
<style>
    /* [Existing styles...] */
</style>

<div class="notifications-container">
    <div class="page-header">
        <h1>游닉 Obave코tenja</h1>
    </div>

    <!-- Stats Cards - A콯URIRANO -->
    <div class="stats-row">
        <div class="stat-card">
            <i class="fas fa-paper-plane"></i>
            <h3 id="sent-count">0</h3>
            <p>Poslato</p>
        </div>
        <div class="stat-card">
            <i class="fas fa-check-circle"></i>
            <h3 id="success-count">0</h3>
            <p>Uspe코no</p>
        </div>
        <div class="stat-card">
            <i class="fas fa-times-circle"></i>
            <h3 id="failed-count">0</h3>
            <p>Neuspe코no</p>
        </div>
        <div class="stat-card">
            <i class="fas fa-percentage"></i>
            <h3 id="success-rate">0%</h3>
            <p>Stopa uspeha</p>
        </div>
    </div>

    <!-- Filter Tabs -->
    <div class="filter-tabs">
        <button class="tab-btn active" data-filter="all" onclick="filterNotifications('all')">
            Sve <span class="badge" id="badge-all">0</span>
        </button>
        <button class="tab-btn" data-filter="email" onclick="filterNotifications('email')">
            <i class="fas fa-envelope"></i> Email <span class="badge" id="badge-email">0</span>
        </button>
        <button class="tab-btn" data-filter="sms" onclick="filterNotifications('sms')">
            <i class="fas fa-sms"></i> SMS <span class="badge" id="badge-sms">0</span>
        </button>
    </div>

    <!-- Notifications List -->
    <div class="notifications-list" id="notificationsList">
        <!-- Populated by JavaScript -->
    </div>
</div>

<script>
let allNotifications = [];
let currentFilter = 'all';

document.addEventListener('DOMContentLoaded', function() {
    loadNotificationStats();
    loadNotifications();
});

function loadNotificationStats() {
    fetch('/obavestenja/stats/')
        .then(response => response.json())
        .then(data => {
            // Update stat cards
            document.getElementById('sent-count').textContent = data.total_sent;
            document.getElementById('success-count').textContent = data.total_success;
            document.getElementById('failed-count').textContent = data.total_failed;
            document.getElementById('success-rate').textContent = data.success_rate + '%';
            
            // Update badges
            document.getElementById('badge-all').textContent = data.total_sent;
            document.getElementById('badge-email').textContent = data.email_count;
            document.getElementById('badge-sms').textContent = data.sms_count;
        })
        .catch(error => {
            console.error('Error loading stats:', error);
        });
}

function loadNotifications() {
    fetch('/obavestenja/json/')
        .then(response => response.json())
        .then(data => {
            allNotifications = data.notifications;
            renderNotifications();
        })
        .catch(error => {
            console.error('Error loading notifications:', error);
            document.getElementById('notificationsList').innerHTML = 
                '<div class="no-notifications"><i class="fas fa-inbox"></i><p>Gre코ka pri u캜itavanju obave코tenja</p></div>';
        });
}

function renderNotifications() {
    const container = document.getElementById('notificationsList');
    
    // Filter notifications
    let filtered = allNotifications;
    if (currentFilter !== 'all') {
        filtered = allNotifications.filter(n => n.tip === currentFilter);
    }
    
    if (filtered.length === 0) {
        container.innerHTML = '<div class="no-notifications"><i class="fas fa-inbox"></i><p>Nema obave코tenja</p></div>';
        return;
    }
    
    container.innerHTML = '';
    filtered.forEach(notification => {
        const card = document.createElement('div');
        card.className = 'notification-card';
        
        const statusClass = notification.status === 'sent' ? 'status-success' : 
                           notification.status === 'failed' ? 'status-failed' : 'status-pending';
        
        const statusText = notification.status === 'sent' ? 'Poslato' : 
                          notification.status === 'failed' ? 'Neuspe코no' : 'Na 캜ekanju';
        
        const typeIcon = notification.tip === 'email' ? 'fa-envelope' : 'fa-sms';
        const typeBadge = notification.tip === 'email' ? 'type-badge-email' : 'type-badge-sms';
        
        card.innerHTML = `
            <div class="notification-header">
                <div class="notification-title">
                    <i class="fas ${typeIcon}"></i>
                    <span>${notification.naslov || 'Bez naslova'}</span>
                </div>
                <div class="notification-meta">
                    <span class="type-badge ${typeBadge}">${notification.tip.toUpperCase()}</span>
                    <span class="status-badge ${statusClass}">${statusText}</span>
                </div>
            </div>
            <div class="notification-body">
                <p><strong>Prima:</strong> ${notification.prima}</p>
                <p><strong>Poruka:</strong> ${notification.poruka}</p>
                ${notification.error_message ? `<p class="error-message"><i class="fas fa-exclamation-triangle"></i> ${notification.error_message}</p>` : ''}
            </div>
            <div class="notification-footer">
                <span><i class="fas fa-clock"></i> ${formatDateTime(notification.poslato_u)}</span>
            </div>
        `;
        
        container.appendChild(card);
    });
}

function filterNotifications(filter) {
    currentFilter = filter;
    
    // Update active tab
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.filter === filter) {
            btn.classList.add('active');
        }
    });
    
    renderNotifications();
}

function formatDateTime(dateString) {
    const date = new Date(dateString);
    return date.toLocaleString('sr-RS', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}
</script>

{% endblock %}
