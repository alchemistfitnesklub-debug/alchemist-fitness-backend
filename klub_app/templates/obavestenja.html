{% extends 'base.html' %}
{% load static %}

{% block title %}Obaveštenja - Fitness Klub{% endblock %}

{% block extra_head %}
<style>
/* ========================================
   OBAVEŠTENJA - MODERNIZOVAN DIZAJN
   ======================================== */

/* KARTICE STATISTIKE */
.stats-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.05));
    border-radius: 15px;
    padding: 25px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    transition: transform 0.3s, box-shadow 0.3s;
    text-align: center;
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
}

.stat-card i {
    font-size: 2.5em;
    margin-bottom: 15px;
    opacity: 0.9;
}

.stat-card h3 {
    font-size: 2em;
    margin: 10px 0;
    font-weight: bold;
}

.stat-card p {
    font-size: 0.95em;
    opacity: 0.85;
    margin: 5px 0;
}

.stat-card.blue { color: #4facfe; }
.stat-card.green { color: #43e97b; }
.stat-card.red { color: #ff4444; }
.stat-card.purple { color: #667eea; }

body.dark-theme .stat-card {
    background: linear-gradient(135deg, rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.2));
    border: 1px solid rgba(255, 255, 255, 0.1);
}

/* SECTION KARTICE */
.section-card {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 15px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    backdrop-filter: blur(10px);
    padding: 25px;
    margin: 20px 0;
    border: 1px solid rgba(255, 255, 255, 0.2);
}

body.dark-theme .section-card {
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.section-header {
    display: flex;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid rgba(255, 255, 255, 0.2);
}

.section-header i {
    font-size: 1.8em;
    margin-right: 15px;
    color: #00bfff;
}

.section-header h2 {
    margin: 0;
    font-size: 1.5em;
}

/* FILTER FORMA */
.filter-card {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 30px;
    border: 1px solid rgba(255, 255, 255, 0.2);
}

body.dark-theme .filter-card {
    background: rgba(0, 0, 0, 0.3);
}

.filter-grid {
    display: grid;
    grid-template-columns: 2fr 2fr 2fr 1fr;
    gap: 15px;
    align-items: end;
}

.filter-group {
    display: flex;
    flex-direction: column;
}

.filter-group label {
    margin-bottom: 8px;
    font-weight: 600;
    font-size: 0.95em;
    color: #e0e0e0;
}

body.dark-theme .filter-group label {
    color: #fff;
}

.filter-group input[type="date"],
.filter-group input[type="checkbox"] {
    padding: 12px 15px;
    border-radius: 10px;
    border: 2px solid rgba(255, 255, 255, 0.2);
    background: rgba(255, 255, 255, 0.9);
    color: #333;
    font-size: 1em;
    transition: all 0.3s;
}

body.dark-theme .filter-group input[type="date"] {
    background: rgba(0, 0, 0, 0.5);
    color: #fff;
    border: 2px solid rgba(255, 255, 255, 0.3);
}

.filter-group input:focus {
    outline: none;
    border-color: #00bfff;
    box-shadow: 0 0 15px rgba(0, 191, 255, 0.3);
}

.checkbox-label {
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
    margin-top: 8px;
}

.checkbox-label input[type="checkbox"] {
    width: 20px;
    height: 20px;
    cursor: pointer;
}

/* DUGMIĆI */
.btn-primary {
    background: linear-gradient(135deg, #00bfff, #0099cc);
    color: white;
    border: none;
    padding: 12px 25px;
    border-radius: 10px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 4px 15px rgba(0, 191, 255, 0.3);
    font-size: 1em;
    width: 100%;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 191, 255, 0.4);
}

/* TABELA */
.table-container {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
}

body.dark-theme .table-container {
    background: rgba(0, 0, 0, 0.6);
}

.table-container table {
    width: 100%;
    margin: 0;
    background: transparent;
}

.table-container th {
    background: linear-gradient(135deg, #2a5298, #1e3c72);
    color: #fff;
    padding: 15px 12px;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.9em;
    letter-spacing: 0.5px;
}

body.dark-theme .table-container th {
    background: linear-gradient(135deg, #4a5568, #2c3e50);
}

.table-container td {
    padding: 12px;
    vertical-align: middle;
}

.table-container tr:hover {
    background: rgba(0, 191, 255, 0.1) !important;
}

body.dark-theme .table-container tr:hover {
    background: rgba(255, 255, 255, 0.05) !important;
}

/* BADGE-OVI */
.badge {
    display: inline-block;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.85em;
    font-weight: 600;
}

.badge-email {
    background: linear-gradient(135deg, #4facfe, #00f2fe);
    color: white;
}

.badge-sms {
    background: linear-gradient(135deg, #43e97b, #38d278);
    color: white;
}

.badge-success {
    background: linear-gradient(135deg, #43e97b, #38d278);
    color: white;
}

.badge-warning {
    background: linear-gradient(135deg, #ffa500, #ff8c00);
    color: white;
}

.badge-danger {
    background: linear-gradient(135deg, #ff4444, #cc0000);
    color: white;
}

/* ROW HIGHLIGHT ZA NEUSPEŠNA */
tr.failed-row {
    background: rgba(255, 68, 68, 0.15) !important;
    border-left: 4px solid #ff4444 !important;
}

body.dark-theme tr.failed-row {
    background: rgba(255, 68, 68, 0.25) !important;
}

/* EMPTY STATE */
.empty-state {
    text-align: center;
    padding: 80px 20px;
    opacity: 0.7;
}

.empty-state i {
    font-size: 5em;
    margin-bottom: 20px;
    opacity: 0.3;
}

.empty-state p {
    font-size: 1.3em;
    margin: 10px 0;
}

/* RESPONSIVE */
@media (max-width: 768px) {
    .stats-row {
        grid-template-columns: 1fr;
    }
    
    .filter-grid {
        grid-template-columns: 1fr;
    }
    
    .section-card {
        padding: 15px;
    }
    
    .table-container {
        overflow-x: auto;
    }
}

/* ANIMACIJE */
@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.section-card {
    animation: slideIn 0.5s ease-out;
}

.stat-card:nth-child(1) { animation-delay: 0.1s; }
.stat-card:nth-child(2) { animation-delay: 0.2s; }
.stat-card:nth-child(3) { animation-delay: 0.3s; }
.stat-card:nth-child(4) { animation-delay: 0.4s; }
</style>
{% endblock %}

{% block content %}
<div style="max-width: 1400px; margin: 0 auto;">
    
    <!-- NASLOV -->
    <div style="text-align: center; margin-bottom: 30px;">
        <h1 style="font-size: 2.5em; margin-bottom: 10px;">
            <i class="fas fa-bell"></i> OBAVEŠTENJA - ISTORIJA
        </h1>
        <p style="opacity: 0.8; font-size: 1.1em;">Pregled svih poslatih obaveštenja</p>
    </div>

    <!-- STATISTIKA DASHBOARD -->
    <div class="stats-row">
        <div class="stat-card blue">
            <i class="fas fa-paper-plane"></i>
            <h3>{{ obavestenja|length }}</h3>
            <p>Ukupno poslato</p>
        </div>
        
        <div class="stat-card green">
            <i class="fas fa-check-circle"></i>
            <h3 id="success-count">
                {% with success_count=obavestenja|length %}
                    {% for ob in obavestenja %}
                        {% if ob.status == 'sent' or ob.status == 'delivered' %}
                            {{ forloop.counter }}
                        {% endif %}
                    {% endfor %}
                {% endwith %}
            </h3>
            <p>Uspešno dostavljeno</p>
        </div>
        
        <div class="stat-card red">
            <i class="fas fa-times-circle"></i>
            <h3 id="failed-count">
                {% for ob in obavestenja %}
                    {% if ob.status == 'failed' %}
                        {{ forloop.counter }}
                    {% endif %}
                {% endfor %}
            </h3>
            <p>Neuspešno</p>
        </div>
        
        <div class="stat-card purple">
            <i class="fas fa-percentage"></i>
            <h3 id="success-rate">
                {% widthratio obavestenja|length 1 100 %}%
            </h3>
            <p>Stopa uspeha</p>
        </div>
    </div>

    <!-- FILTER -->
    <div class="filter-card">
        <form method="get" class="filter-grid">
            <div class="filter-group">
                <label>Od datuma</label>
                <input type="date" name="from_date" value="{{ from_date }}" required>
            </div>
            
            <div class="filter-group">
                <label>Do datuma</label>
                <input type="date" name="to_date" value="{{ to_date }}" required>
            </div>
            
            <div class="filter-group">
                <label class="checkbox-label">
                    <input type="checkbox" name="failed_only" value="true" {% if failed_only %}checked{% endif %}>
                    <span>Samo neuspešna</span>
                </label>
            </div>
            
            <div class="filter-group">
                <button type="submit" class="btn-primary">
                    <i class="fas fa-filter"></i> Filtriraj
                </button>
            </div>
        </form>
    </div>

    <!-- TABELA OBAVEŠTENJA -->
    <div class="section-card">
        <div class="section-header">
            <i class="fas fa-list"></i>
            <h2>Lista obaveštenja (poslednje)</h2>
        </div>
        
        {% if obavestenja %}
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Klijent</th>
                        <th>Tip</th>
                        <th>Poruka</th>
                        <th>Status</th>
                        <th>Datum/Vreme</th>
                    </tr>
                </thead>
                <tbody>
                    {% for ob in obavestenja %}
                    <tr {% if ob.status == 'failed' %}class="failed-row"{% endif %}>
                        <td>
                            <strong style="color: #00bfff;">{{ ob.clan.ime_prezime }}</strong>
                        </td>
                        <td>
                            {% if ob.tip == 'email' %}
                                <span class="badge badge-email">
                                    <i class="fas fa-envelope"></i> EMAIL
                                </span>
                            {% else %}
                                <span class="badge badge-sms">
                                    <i class="fas fa-sms"></i> SMS
                                </span>
                            {% endif %}
                        </td>
                        <td style="max-width: 400px;">
                            {{ ob.poruka|truncatechars:80 }}
                        </td>
                        <td>
                            {% if ob.status == 'delivered' or ob.status == 'sent' %}
                                <span class="badge badge-success">
                                    <i class="fas fa-check-circle"></i> Dostavljeno
                                </span>
                            {% elif ob.status == 'queued' %}
                                <span class="badge badge-warning">
                                    <i class="fas fa-clock"></i> U redu
                                </span>
                            {% else %}
                                <span class="badge badge-danger">
                                    <i class="fas fa-times-circle"></i> Greška
                                </span>
                            {% endif %}
                        </td>
                        <td style="font-size: 0.9em;">
                            {{ ob.datum_slanja|date:"d.m.Y" }}<br>
                            <strong>{{ ob.datum_slanja|time:"H:i" }}</strong>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="empty-state">
            <i class="fas fa-bell-slash"></i>
            <p style="font-weight: bold;">Nema obaveštenja</p>
            <small style="opacity: 0.6;">Nema poslatih obaveštenja za izabrani period</small>
        </div>
        {% endif %}
    </div>

</div>

<script>
// IZRAČUNAJ STATISTIKU
document.addEventListener('DOMContentLoaded', function() {
    const rows = document.querySelectorAll('tbody tr');
    let successCount = 0;
    let failedCount = 0;
    let total = rows.length;
    
    rows.forEach(row => {
        const statusBadge = row.querySelector('.badge');
        if (statusBadge) {
            if (statusBadge.classList.contains('badge-success')) {
                successCount++;
            } else if (statusBadge.classList.contains('badge-danger')) {
                failedCount++;
            }
        }
    });
    
    // Update kartice
    if (total > 0) {
        const successRate = ((successCount / total) * 100).toFixed(1);
        document.getElementById('success-count').textContent = successCount;
        document.getElementById('failed-count').textContent = failedCount;
        document.getElementById('success-rate').textContent = successRate + '%';
    }
});
</script>

{% endblock %}
