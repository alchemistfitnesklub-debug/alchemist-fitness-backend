{% extends 'base.html' %}
{% load static %}

{% block title %}≈†ank - Upravljanje{% endblock %}

{% block extra_head %}
<!-- ========================================
   SPREƒåAVA KE≈†IRANJE STRANICE I PODATAKA
   ======================================== -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<style>
/* ========================================
   ≈†ANK MODUL - MODERNIZOVAN DIZAJN
   ======================================== */

/* KARTICE STATISTIKE - kao na Dashboard-u */
.stats-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.05));
    border-radius: 15px;
    padding: 25px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    transition: transform 0.3s, box-shadow 0.3s;
    text-align: center;
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
}

.stat-card i {
    font-size: 2.5em;
    margin-bottom: 15px;
    opacity: 0.9;
}

.stat-card h3 {
    font-size: 2em;
    margin: 10px 0;
    font-weight: bold;
}

.stat-card p {
    font-size: 0.95em;
    opacity: 0.85;
    margin: 5px 0;
}

/* BOJE ZA RAZLIƒåITE KARTICE */
.stat-card.blue { color: #4facfe; }
.stat-card.purple { color: #667eea; }
.stat-card.pink { color: #f093fb; }
.stat-card.green { color: #43e97b; }

body.dark-theme .stat-card {
    background: linear-gradient(135deg, rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.2));
    border: 1px solid rgba(255, 255, 255, 0.1);
}

/* SEKCIJE SA KARTICAMA */
.section-card {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 15px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    backdrop-filter: blur(10px);
    padding: 25px;
    margin: 20px 0;
    border: 1px solid rgba(255, 255, 255, 0.2);
}

body.dark-theme .section-card {
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.section-header {
    display: flex;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid rgba(255, 255, 255, 0.2);
}

.section-header i {
    font-size: 1.8em;
    margin-right: 15px;
    color: #00bfff;
}

.section-header h2 {
    margin: 0;
    font-size: 1.5em;
}

/* FORME - MODERNE I ORGANIZOVANE */
.form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}

.form-group {
    display: flex;
    flex-direction: column;
}

.form-group label {
    margin-bottom: 8px;
    font-weight: 600;
    font-size: 0.95em;
    color: #e0e0e0;
}

body.dark-theme .form-group label {
    color: #fff;
}

.form-group input,
.form-group select {
    padding: 12px 15px;
    border-radius: 10px;
    border: 2px solid rgba(255, 255, 255, 0.2);
    background: rgba(255, 255, 255, 0.9);
    color: #333;
    font-size: 1em;
    transition: all 0.3s;
}

body.dark-theme .form-group input,
body.dark-theme .form-group select {
    background: rgba(0, 0, 0, 0.5);
    color: #fff;
    border: 2px solid rgba(255, 255, 255, 0.3);
}

.form-group input:focus,
.form-group select:focus {
    outline: none;
    border-color: #00bfff;
    box-shadow: 0 0 15px rgba(0, 191, 255, 0.3);
}

/* AUTOCOMPLETE REZULTATI */
#autocomplete-results {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    max-height: 300px;
    overflow-y: auto;
    background: white;
    border: 2px solid #00bfff;
    border-top: none;
    border-radius: 0 0 10px 10px;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
    z-index: 1000;
    display: none;
}

.autocomplete-item {
    padding: 12px 15px;
    cursor: pointer;
    transition: background 0.2s;
    color: #333;
    border-bottom: 1px solid #f0f0f0;
}

.autocomplete-item:hover {
    background: #f0f8ff;
}

.autocomplete-item:last-child {
    border-bottom: none;
}

.autocomplete-name {
    font-weight: bold;
    margin-bottom: 5px;
}

.autocomplete-krediti {
    color: #00bfff;
    font-weight: 600;
}

/* DUGMIƒÜI */
.btn-primary {
    background: linear-gradient(135deg, #00bfff, #0099cc);
    color: white;
    border: none;
    padding: 12px 25px;
    border-radius: 10px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 4px 15px rgba(0, 191, 255, 0.3);
    font-size: 1em;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 191, 255, 0.4);
    background: linear-gradient(135deg, #0099cc, #007a99);
}

.btn-secondary {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 10px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
}

.btn-secondary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
}

/* TABELA - MODERNIZOVANA */
.table-container {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
}

body.dark-theme .table-container {
    background: rgba(0, 0, 0, 0.6);
}

.table-container table {
    margin: 0;
    background: transparent;
}

.table-container th {
    background: linear-gradient(135deg, #2a5298, #1e3c72);
    color: #fff;
    padding: 15px 12px;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.9em;
    letter-spacing: 0.5px;
}

body.dark-theme .table-container th {
    background: linear-gradient(135deg, #4a5568, #2c3e50);
}

.table-container td {
    padding: 12px;
    vertical-align: middle;
}

.table-container tr:hover {
    background: rgba(0, 191, 255, 0.1) !important;
}

body.dark-theme .table-container tr:hover {
    background: rgba(255, 255, 255, 0.05) !important;
}

/* BADGE ZA PROIZVODE */
.product-badge {
    display: inline-block;
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 0.85em;
    font-weight: 600;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
}

/* RESPONSIVE */
@media (max-width: 768px) {
    .stats-row {
        grid-template-columns: 1fr;
    }
    
    .form-grid {
        grid-template-columns: 1fr;
    }
    
    .section-card {
        padding: 15px;
    }
}

/* ANIMACIJE */
@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.section-card {
    animation: slideIn 0.5s ease-out;
}

.stat-card:nth-child(1) { animation-delay: 0.1s; }
.stat-card:nth-child(2) { animation-delay: 0.2s; }
.stat-card:nth-child(3) { animation-delay: 0.3s; }
.stat-card:nth-child(4) { animation-delay: 0.4s; }

/* AUTOCOMPLETE DODATNI STILOVI */
.autocomplete-results {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 2px solid #00bfff;
    border-top: none;
    border-radius: 0 0 10px 10px;
    max-height: 300px;
    overflow-y: auto;
    z-index: 1000;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
    margin-top: 5px;
    display: none;
}

.autocomplete-results.show {
    display: block;
}

.autocomplete-item {
    padding: 12px 15px;
    cursor: pointer;
    transition: background 0.2s;
    color: #333;
    border-bottom: 1px solid #f0f0f0;
}

.autocomplete-item:hover {
    background: #f8f9fa;
}

.autocomplete-item:last-child {
    border-bottom: none;
}

.autocomplete-item strong {
    color: #333;
    display: block;
    margin-bottom: 3px;
}

.autocomplete-item.no-results {
    text-align: center;
    color: #999;
    cursor: default;
}

.autocomplete-item.no-results:hover {
    background: white;
}

.autocomplete-loading {
    text-align: center;
    padding: 15px;
    color: #666;
}

/* ALERT STILOVI */
.alert {
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 0;
}

.alert-info {
    background: rgba(0, 191, 255, 0.1);
    border: 1px solid rgba(0, 191, 255, 0.3);
    color: #00bfff;
}

body.dark-theme .alert-info {
    background: rgba(0, 191, 255, 0.15);
    border-color: rgba(0, 191, 255, 0.4);
}

/* MODAL STILOVI */
.modal {
    background: rgba(0, 0, 0, 0.5);
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 9999;
}

.modal-dialog {
    position: relative;
    width: auto;
    margin: 1.75rem auto;
    max-width: 500px;
}

.modal-dialog-centered {
    display: flex;
    align-items: center;
    min-height: calc(100% - 3.5rem);
}

.modal-content {
    position: relative;
    display: flex;
    flex-direction: column;
    width: 100%;
    pointer-events: auto;
    background-color: #fff;
    background-clip: padding-box;
    border: 1px solid rgba(0,0,0,.2);
    border-radius: 15px;
    outline: 0;
}

.modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem;
    border-bottom: 1px solid #dee2e6;
}

.modal-title {
    margin: 0;
    line-height: 1.5;
}

.modal-body {
    position: relative;
    flex: 1 1 auto;
    padding: 1rem;
}

.modal-footer {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    justify-content: flex-end;
    padding: 0.75rem;
    border-top: 1px solid #dee2e6;
}

.btn-close {
    background: transparent url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23fff'%3e%3cpath d='M.293.293a1 1 0 011.414 0L8 6.586 14.293.293a1 1 0 111.414 1.414L9.414 8l6.293 6.293a1 1 0 01-1.414 1.414L8 9.414l-6.293 6.293a1 1 0 01-1.414-1.414L6.586 8 .293 1.707a1 1 0 010-1.414z'/%3e%3c/svg%3e") center/1em auto no-repeat;
    border: 0;
    width: 1em;
    height: 1em;
    padding: 0.25em;
    opacity: 0.5;
    cursor: pointer;
}

.btn-close:hover {
    opacity: 0.75;
}

.modal.fade {
    opacity: 0;
}

.modal.show {
    opacity: 1;
}

body.dark-theme .modal-content {
    background: rgba(30, 30, 30, 0.98);
    color: #fff;
    border-color: rgba(255, 255, 255, 0.1);
}

body.dark-theme .modal-header {
    border-bottom-color: rgba(255, 255, 255, 0.1);
}

body.dark-theme .modal-footer {
    border-top-color: rgba(255, 255, 255, 0.1);
}

/* ========================================
   SMOOTH MODAL ANIMACIJE I LOADING STATE
   ======================================== */

/* Br≈æe modal animacije (150ms umesto 300ms) */
.modal.fade .modal-dialog {
    transition: transform 0.15s ease-out;
}

.modal.show .modal-dialog {
    transform: none;
}

/* Loading spinner animacija */
@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.fa-spinner {
    animation: spin 1s linear infinite;
}

/* Disable pointer events tokom submit-a */
form.submitting {
    pointer-events: none;
    opacity: 0.7;
}

/* Button disabled state */
button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

/* Smooth transitions */
* {
    transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
}
</style>

<!-- Bootstrap 5 CDN za Modal funkcionalnost -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

{% endblock %}

{% block content %}
<div style="max-width: 1400px; margin: 0 auto;">
    
    <!-- NASLOV -->
    <div style="text-align: center; margin-bottom: 30px;">
        <h1 style="font-size: 2.5em; margin-bottom: 10px;">
            <i class="fas fa-coffee"></i> ≈†ANK - UPRAVLJANJE
        </h1>
        <p style="opacity: 0.8; font-size: 1.1em;">Upravljanje proizvodima, zalihama i prodajom</p>
    </div>

    <!-- STATISTIKA - DASHBOARD KARTICE -->
    <div class="stats-row">
        <div class="stat-card blue">
            <i class="fas fa-euro-sign"></i>
            <h3>{{ danas_zarada|floatformat:2 }} ‚Ç¨</h3>
            <p>Zarada danas</p>
        </div>
        
        <div class="stat-card purple">
            <i class="fas fa-shopping-cart"></i>
            <h3>{{ danas_prodato }}</h3>
            <p>Proizvoda prodato danas</p>
        </div>
        
        <div class="stat-card pink">
            <i class="fas fa-box"></i>
            <h3>{{ ukupno_proizvoda }}</h3>
            <p>Ukupno proizvoda</p>
        </div>
        
        <div class="stat-card green">
            <i class="fas fa-star"></i>
            <h3>{{ najprodavaniji|default:"N/A" }}</h3>
            <p>Najprodavaniji danas</p>
        </div>
    </div>

    <!-- DODAJ NOVI PROIZVOD -->
    <div class="section-card">
        <div class="section-header">
            <i class="fas fa-plus-circle"></i>
            <h2>Dodaj novi proizvod</h2>
        </div>
        
        <form method="post" action="{% url 'sank' %}">
            {% csrf_token %}
            <input type="hidden" name="add_product">
            
            <div class="form-grid">
                <div class="form-group">
                    <label for="naziv_proizvoda">Naziv proizvoda</label>
                    <input type="text" id="naziv_proizvoda" name="naziv" placeholder="Npr. ROSA - Voda 0.5" required>
                </div>
                
                <div class="form-group">
                    <label for="kolicina">Koliƒçina</label>
                    <input type="number" id="kolicina" name="kolicina" placeholder="0" step="1" min="0" required>
                </div>
                
                <div class="form-group">
                    <label for="cena">Cena (EUR)</label>
                    <input type="number" id="cena" name="cena" placeholder="0.00" step="0.01" min="0" required>
                </div>
            </div>
            
            <button type="submit" class="btn-primary">
                <i class="fas fa-plus"></i> Dodaj proizvod
            </button>
        </form>
    </div>

    <!-- A≈ΩURIRAJ ZALIHE -->
    <div class="section-card">
        <div class="section-header">
            <i class="fas fa-warehouse"></i>
            <h2>A≈æuriraj zalihe</h2>
        </div>
        
        <form method="post" action="{% url 'sank' %}">
            {% csrf_token %}
            <input type="hidden" name="update_stock">
            
            <div class="form-grid">
                <div class="form-group">
                    <label for="izaberi_proizvod">Izaberi proizvod</label>
                    <select id="izaberi_proizvod" name="stock_id" required>
                        <option value="">-- Izaberi proizvod --</option>
                        {% for stock in stocks %}
                        <option value="{{ stock.id }}">
                            {{ stock.naziv }} (Trenutno: {{ stock.kolicina }})
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="dodatna_kolicina">Dodatna koliƒçina</label>
                    <input type="number" id="dodatna_kolicina" name="dodatna_kolicina" placeholder="0" step="1" required>
                </div>
            </div>
            
            <button type="submit" class="btn-secondary">
                <i class="fas fa-sync"></i> A≈æuriraj zalihe
            </button>
        </form>
    </div>

    <!-- NOVA PRODAJA - KORISTI POSTOJEƒÜI AUTOCOMPLETE I MODAL -->
    <div class="section-card">
        <div class="section-header">
            <i class="fas fa-cash-register"></i>
            <h2>Nova prodaja</h2>
        </div>
        
        <form method="post" id="saleForm">
            {% csrf_token %}
            
            <div class="form-grid">
                <div class="form-group" style="position: relative;">
                    <label for="clanSearchInput">Klijent</label>
                    <input type="text" 
                           id="clanSearchInput" 
                           placeholder="üîç Pretra≈æi klijente..." 
                           autocomplete="off">
                    <input type="hidden" name="clan" id="clanIdInput" required>
                    <button type="button" id="clearClan" style="display: none; position: absolute; right: 10px; top: 38px; border: none; background: none; cursor: pointer; font-size: 18px; color: #999;">‚úï</button>
                    <div id="autocompleteResults" class="autocomplete-results"></div>
                    <div id="selectedClan" style="display: none; margin-top: 10px;">
                        <div class="alert alert-info mb-0" style="background: rgba(0,191,255,0.1); border: 1px solid rgba(0,191,255,0.3); padding: 10px; border-radius: 10px;">
                            <strong id="selectedClanName" style="color: #00bfff;"></strong>
                            <br>
                            <small>Krediti: <span id="selectedClanKrediti" class="fw-bold" style="color: #00bfff;"></span> ‚Ç¨</small>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="stockSelect">Proizvod</label>
                    <select id="stockSelect" name="stock" required>
                        <option value="">-- Izaberi proizvod --</option>
                        {% for stock in stocks %}
                        <option value="{{ stock.id }}" data-cena="{{ stock.cena }}">
                            {{ stock.naziv }} - {{ stock.cena }} EUR ({{ stock.kolicina }} kom)
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="kolicinaInput">Koliƒçina</label>
                    <input type="number" id="kolicinaInput" name="kolicina" placeholder="1" step="1" min="1" value="1" required>
                </div>
                
                <div class="form-group">
                    <label>Ukupna cena</label>
                    <div style="display: flex; align-items: center;">
                        <input type="text" id="ukupnaCenaDisplay" style="flex: 1; font-weight: bold; font-size: 1.1em;" readonly value="0.00">
                        <span style="margin-left: 10px; font-weight: bold;">‚Ç¨</span>
                    </div>
                </div>
            </div>
            
            <button type="submit" class="btn-primary" style="width: 100%;">
                <i class="fas fa-shopping-cart"></i> Zavr≈°i prodaju
            </button>
        </form>
    </div>

    <!-- ISTORIJA PRODAJE -->
    <div class="section-card">
        <div class="section-header">
            <i class="fas fa-history"></i>
            <h2>Istorija prodaje</h2>
        </div>
        
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Klijent</th>
                        <th>Proizvod</th>
                        <th>Koliƒçina</th>
                        <th>Ukupna cena</th>
                        <th>Datum i vreme</th>
                    </tr>
                </thead>
                <tbody>
                    {% for sale in sales %}
                    <tr>
                        <td>
                            <strong style="color: #00bfff;">{{ sale.clan.ime_prezime }}</strong>
                        </td>
                        <td>
                            <span class="product-badge">{{ sale.stock.naziv }}</span>
                        </td>
                        <td style="text-align: center;">
                            <strong>{{ sale.kolicina }}</strong>
                        </td>
                        <td>
                            <strong style="color: #43e97b; font-size: 1.1em;">{{ sale.price|floatformat:2 }} EUR</strong>
                        </td>
                        <td style="font-size: 0.9em; opacity: 0.8;">
                            {{ sale.datum|date:"d.m.Y" }}<br>
                            <strong>{{ sale.datum|time:"H:i" }}</strong>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 30px;">
                            <i class="fas fa-inbox" style="font-size: 3em; opacity: 0.3;"></i>
                            <p style="margin-top: 15px; opacity: 0.6;">Nema prodaje za prikaz</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

</div>

<!-- POPUP ZA MINUS - POSTOJEƒÜI MODAL -->
<div class="modal fade" id="minusModal" tabindex="-1" style="display: none;">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 15px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #f093fb, #f5576c); color: white; border-radius: 15px 15px 0 0;">
                <h5 class="modal-title">‚ö†Ô∏è UPOZORENJE: MINUS KREDITA!</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center" style="padding: 30px;">
                <h4 id="minusAmount" style="color: #f5576c; margin-bottom: 20px;"></h4>
                <p style="font-size: 1.1em;">Klijent ƒáe uƒái u minus. Da li ≈æelite da nastavite?</p>
            </div>
            <div class="modal-footer" style="border-top: none; justify-content: center; padding-bottom: 20px;">
                <button type="button" class="btn-secondary" data-bs-dismiss="modal">Otka≈æi</button>
                <button type="button" class="btn-primary" id="confirmMinus">Nastavi</button>
            </div>
        </div>
    </div>
</div>

<!-- JAVASCRIPT - OPTIMIZOVANA VERZIJA -->
<script>
    const stocksData = {{ stocks_json|safe }};
    let currentKrediti = 0;
    let selectedClanId = null;
    let selectedClanName = '';
    let minusConfirmed = false;
    let searchTimeout = null;
    let minusModal = null;
    let isSubmitting = false; // ‚úÖ Spreƒçava double submit

    // Autocomplete funkcionalnost
    const searchInput = document.getElementById('clanSearchInput');
    const resultsDiv = document.getElementById('autocompleteResults');
    const clanIdInput = document.getElementById('clanIdInput');
    const selectedClanDiv = document.getElementById('selectedClan');
    const clearBtn = document.getElementById('clearClan');

    if (searchInput) {
        searchInput.addEventListener('input', function() {
            const query = this.value.trim();
            
            if (query === '') {
                clearBtn.style.display = 'none';
                resultsDiv.classList.remove('show');
                return;
            }
            
            clearBtn.style.display = 'block';
            clearTimeout(searchTimeout);
            
            if (query.length < 2) {
                resultsDiv.innerHTML = '<div class="autocomplete-item no-results">Ukucaj minimum 2 slova...</div>';
                resultsDiv.classList.add('show');
                return;
            }
            
            searchTimeout = setTimeout(() => {
                resultsDiv.innerHTML = '<div class="autocomplete-loading">Pretraga...</div>';
                resultsDiv.classList.add('show');
                
                // ‚úÖ Cache-busting
                fetch(`/sank/json/clanovi/?q=${encodeURIComponent(query)}&_=${Date.now()}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.length === 0) {
                            resultsDiv.innerHTML = '<div class="autocomplete-item no-results">Nema rezultata</div>';
                        } else {
                            resultsDiv.innerHTML = data.map(clan => `
                                <div class="autocomplete-item" data-id="${clan.id}" data-name="${clan.ime_prezime}">
                                    <strong>${clan.ime_prezime}</strong>
                                </div>
                            `).join('');
                            
                            resultsDiv.querySelectorAll('.autocomplete-item').forEach(item => {
                                item.addEventListener('click', function() {
                                    selectClan(this.dataset.id, this.dataset.name);
                                });
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Gre≈°ka pri pretrazi:', error);
                        resultsDiv.innerHTML = '<div class="autocomplete-item no-results">Gre≈°ka pri pretrazi</div>';
                    });
            }, 300);
        });
    }

    // Funkcija za izbor klijenta
    function selectClan(clanId, clanName) {
        selectedClanId = clanId;
        selectedClanName = clanName;
        
        clanIdInput.value = clanId;
        searchInput.value = clanName;
        resultsDiv.classList.remove('show');
        
        // ‚úÖ FIX: Ispravan URL endpoint + cache-busting
        fetch(`/krediti/${clanId}/?_=${Date.now()}`)
            .then(r => r.json())
            .then(data => {
                currentKrediti = parseFloat(data.krediti_voda) || 0;
                
                document.getElementById('selectedClanName').textContent = clanName;
                document.getElementById('selectedClanKrediti').textContent = currentKrediti.toFixed(2);
                
                const alertDiv = selectedClanDiv.querySelector('.alert');
                if (currentKrediti < 0) {
                    alertDiv.style.background = 'rgba(255, 68, 68, 0.1)';
                    alertDiv.style.borderColor = 'rgba(255, 68, 68, 0.3)';
                } else {
                    alertDiv.style.background = 'rgba(0, 191, 255, 0.1)';
                    alertDiv.style.borderColor = 'rgba(0, 191, 255, 0.3)';
                }
                
                selectedClanDiv.style.display = 'block';
            })
            .catch(err => {
                console.error('Gre≈°ka pri uƒçitavanju kredita:', err);
            });
    }

    // Clear dugme
    if (clearBtn) {
        clearBtn.addEventListener('click', function() {
            searchInput.value = '';
            clanIdInput.value = '';
            selectedClanId = null;
            selectedClanName = '';
            currentKrediti = 0;
            resultsDiv.classList.remove('show');
            selectedClanDiv.style.display = 'none';
            clearBtn.style.display = 'none';
            searchInput.focus();
        });
    }

    // Zatvori rezultate ako se klikne van
    document.addEventListener('click', function(e) {
        if (searchInput && !searchInput.contains(e.target) && !resultsDiv.contains(e.target)) {
            resultsDiv.classList.remove('show');
        }
    });

    // Automatsko raƒçunanje ukupne cene
    function updatePrice() {
        const stockSelect = document.getElementById('stockSelect');
        const kolicinaInput = document.getElementById('kolicinaInput');
        const ukupnaCenaDisplay = document.getElementById('ukupnaCenaDisplay');
        
        if (stockSelect && kolicinaInput) {
            const selectedOption = stockSelect.options[stockSelect.selectedIndex];
            const cena = parseFloat(selectedOption.dataset.cena) || 0;
            const kolicina = parseInt(kolicinaInput.value) || 0;
            const ukupnaCena = cena * kolicina;
            
            ukupnaCenaDisplay.value = ukupnaCena.toFixed(2);
        }
    }

    // ‚úÖ NOVA FUNKCIJA: Show loading state
    function showLoading(button) {
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Obraƒëujem...';
    }

    // ‚úÖ NOVA FUNKCIJA: Direktan submit bez ƒçekanja
    function submitFormDirectly() {
        const form = document.getElementById('saleForm');
        if (form && !isSubmitting) {
            isSubmitting = true;
            
            // Prika≈æi loading
            const submitBtn = form.querySelector('button[type="submit"]');
            if (submitBtn) {
                showLoading(submitBtn);
            }
            
            // Submit odmah
            form.submit();
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        const stockSelect = document.getElementById('stockSelect');
        const kolicinaInput = document.getElementById('kolicinaInput');
        
        if (stockSelect) stockSelect.addEventListener('change', updatePrice);
        if (kolicinaInput) kolicinaInput.addEventListener('input', updatePrice);

        // ‚úÖ OPTIMIZOVANO: Inicijalizuj modal bez animacija (br≈æe)
        const minusModalElement = document.getElementById('minusModal');
        if (minusModalElement && typeof bootstrap !== 'undefined') {
            minusModal = new bootstrap.Modal(minusModalElement, {
                backdrop: 'static',  // Ne zatvara se klikom van
                keyboard: false      // Ne zatvara se ESC tasterom
            });
            
            minusModalElement.addEventListener('hidden.bs.modal', function () {
                minusConfirmed = false;
            });
        }

        // ‚úÖ OPTIMIZOVANO: Submit forma
        const form = document.getElementById('saleForm');
        if (form) {
            form.addEventListener('submit', function(e) {
                // ‚úÖ Ako je veƒá potvrƒëen minus, submit odmah
                if (minusConfirmed) {
                    minusConfirmed = false;
                    isSubmitting = true;
                    
                    const submitBtn = form.querySelector('button[type="submit"]');
                    if (submitBtn) showLoading(submitBtn);
                    
                    return true; // Dozvoli submit
                }

                e.preventDefault(); // Zaustavi default submit
                
                // ‚úÖ Provera da li je veƒá u procesu
                if (isSubmitting) {
                    return false;
                }
                
                if (!selectedClanId) {
                    alert('Molimo izaberite klijenta!');
                    if (searchInput) searchInput.focus();
                    return false;
                }
                
                const selectedOption = stockSelect.options[stockSelect.selectedIndex];
                const cena = parseFloat(selectedOption.dataset.cena) || 0;
                const kolicina = parseInt(kolicinaInput.value) || 0;
                const ukupnaCena = cena * kolicina;
                
                if (ukupnaCena <= 0) {
                    alert('Molimo popunite sva polja!');
                    return false;
                }

                const noviKrediti = currentKrediti - ukupnaCena;
                
                // ‚úÖ MINUS DETEKCIJA
                if (noviKrediti < 0 && minusModal) {
                    const minusAmount = Math.abs(noviKrediti).toFixed(2);
                    
                    document.getElementById('minusAmount').innerHTML = 
                        `<strong>${selectedClanName}</strong> ƒáe uƒái u minus: <span style="color: #f5576c;">-${minusAmount} EUR</span>`;
                    
                    minusModal.show();
                } else {
                    // ‚úÖ Direktan submit ako nema minusa
                    submitFormDirectly();
                }
                
                return false;
            });
        }
        
        // ‚úÖ OPTIMIZOVANO: "Nastavi" dugme u modalu
        const confirmMinusBtn = document.getElementById('confirmMinus');
        if (confirmMinusBtn) {
            confirmMinusBtn.addEventListener('click', function() {
                minusConfirmed = true;
                
                // ‚úÖ Sakrij modal BEZ animacije (br≈æe)
                if (minusModal && minusModalElement) {
                    minusModalElement.style.display = 'none';
                    document.body.classList.remove('modal-open');
                    const backdrop = document.querySelector('.modal-backdrop');
                    if (backdrop) backdrop.remove();
                }
                
                // ‚úÖ Submit ODMAH bez timeout-a
                submitFormDirectly();
            });
        }
    });
</script>
{% endblock %}
