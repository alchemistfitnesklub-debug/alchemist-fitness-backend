{% extends 'base.html' %}
{% load static %}
{% block title %}≈†ank{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <h1 class="text-center mb-5 text-primary">≈†ANK - UPRAVLJANJE</h1>
        </div>
    </div>

    <!-- DODAJ PROIZVOD -->
    <div class="row mb-5">
        <div class="col-md-6 mx-auto">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">Dodaj novi proizvod</h5>
                </div>
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}
                        <input type="hidden" name="add_product">
                        <div class="mb-3">
                            <label class="form-label">Naziv proizvoda</label>
                            <input type="text" name="naziv" class="form-control rounded-pill" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Koliƒçina</label>
                            <input type="number" name="kolicina" class="form-control rounded-pill" min="0" value="0" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Cena (EUR)</label>
                            <input type="number" name="cena" class="form-control rounded-pill" step="0.01" min="0" required>
                        </div>
                        <button type="submit" class="btn btn-success w-100 rounded-pill">Dodaj proizvod</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- A≈ΩURIRAJ ZALIHE -->
    <div class="row mb-5">
        <div class="col-md-6 mx-auto">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">A≈æuriraj zalihe</h5>
                </div>
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}
                        <input type="hidden" name="update_stock">
                        <div class="mb-3">
                            <label class="form-label">Izaberi proizvod</label>
                            <select name="stock_id" class="form-select rounded-pill" required>
                                <option value="">-- Izaberi --</option>
                                {% for stock in stocks %}
                                <option value="{{ stock.id }}">{{ stock.naziv }} ({{ stock.kolicina }} kom)</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Dodatna koliƒçina</label>
                            <input type="number" name="dodatna_kolicina" class="form-control rounded-pill" min="1" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100 rounded-pill">A≈æuriraj zalihe</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- PRODAJA SA AUTOCOMPLETE -->
    <div class="row mb-5">
        <div class="col-md-8 mx-auto">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">Nova prodaja</h5>
                </div>
                <div class="card-body">
                    <form method="post" id="saleForm">
                        {% csrf_token %}
                        <div class="row">
                            <!-- AUTOCOMPLETE PRETRAGA KLIJENATA -->
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Klijent</label>
                                <div class="autocomplete-wrapper" style="position: relative;">
                                    <input 
                                        type="text" 
                                        id="clanSearchInput" 
                                        class="form-control"
                                        placeholder="üîç Pretra≈æi po imenu..." 
                                        autocomplete="off"
                                        style="border-radius: 25px; padding-right: 40px;">
                                    
                                    <input type="hidden" name="clan" id="clanIdInput" required>
                                    
                                    <!-- Clear button -->
                                    <button type="button" id="clearClan" style="display: none; position: absolute; right: 10px; top: 8px; border: none; background: none; cursor: pointer; font-size: 18px; color: #999;">
                                        ‚úï
                                    </button>
                                    
                                    <!-- Autocomplete rezultati -->
                                    <div id="autocompleteResults" class="autocomplete-results"></div>
                                    
                                    <!-- Prikaz izabranog klijenta -->
                                    <div id="selectedClan" style="display: none; margin-top: 10px;">
                                        <div class="alert alert-info mb-0" style="border-radius: 15px;">
                                            <strong id="selectedClanName"></strong>
                                            <br>
                                            <small>Krediti: <span id="selectedClanKrediti" class="fw-bold"></span> ‚Ç¨</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Proizvod</label>
                                <select name="stock" id="stockSelect" class="form-select" style="border-radius: 25px;" required>
                                    <option value="">-- Izaberi proizvod --</option>
                                    {% for stock in stocks %}
                                    <option value="{{ stock.id }}" data-cena="{{ stock.cena }}">
                                        {{ stock.naziv }} - {{ stock.cena }} ‚Ç¨ ({{ stock.kolicina }} kom)
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Koliƒçina</label>
                                <input type="number" name="kolicina" id="kolicinaInput" class="form-control" style="border-radius: 25px;" min="1" value="1" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Ukupna cena</label>
                                <div class="input-group">
                                    <input type="text" id="ukupnaCenaDisplay" class="form-control" style="border-radius: 25px 0 0 25px; font-weight: bold; font-size: 1.1rem;" readonly value="0.00">
                                    <span class="input-group-text" style="border-radius: 0 25px 25px 0; background: #f8f9fa;">‚Ç¨</span>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-danger w-100" style="border-radius: 25px; font-weight: bold; font-size: 1.1rem;">Zavr≈°i prodaju</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- ISTORIJA PRODAJA -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">Istorija prodaja</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Klijent</th>
                                    <th>Proizvod</th>
                                    <th>Koliƒçina</th>
                                    <th>Cena</th>
                                    <th>Datum</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for sale in sales %}
                                <tr>
                                    <td>{{ sale.clan.ime_prezime }}</td>
                                    <td>{{ sale.stock.naziv }}</td>
                                    <td>{{ sale.kolicina }}</td>
                                    <td><strong>{{ sale.price }} EUR</strong></td>
                                    <td>{{ sale.datum|date:"d.m.Y H:i" }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="5" class="text-center py-4">Nema prodaja</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- POPUP ZA MINUS -->
<div class="modal fade" id="minusModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">‚ö†Ô∏è UPOZORENJE: MINUS KREDITA!</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <h4 id="minusAmount"></h4>
                <p>Klijent ƒáe uƒái u minus. Da li ≈æelite da nastavite?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary rounded-pill" data-bs-dismiss="modal">Otka≈æi</button>
                <button type="button" class="btn btn-danger rounded-pill" id="confirmMinus">Nastavi</button>
            </div>
        </div>
    </div>
</div>

<style>
    .card { border-radius: 15px; overflow: hidden; }
    .card-header { font-weight: bold; font-size: 1.1rem; }
    .table th { background-color: #f8f9fa; font-weight: 600; }
    .modal-content { border-radius: 15px; }
    
    /* Autocomplete styling */
    .autocomplete-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-radius: 10px;
        max-height: 250px;
        overflow-y: auto;
        z-index: 1000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        margin-top: 5px;
        display: none;
    }
    
    .autocomplete-results.show {
        display: block;
    }
    
    .autocomplete-item {
        padding: 12px 15px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
        transition: background 0.2s;
    }
    
    .autocomplete-item:last-child {
        border-bottom: none;
    }
    
    .autocomplete-item:hover {
        background: #f8f9fa;
    }
    
    .autocomplete-item strong {
        color: #333;
        display: block;
        margin-bottom: 3px;
    }
    
    .autocomplete-item small {
        color: #666;
        font-size: 0.85rem;
    }
    
    .autocomplete-item.no-results {
        text-align: center;
        color: #999;
        cursor: default;
    }
    
    .autocomplete-item.no-results:hover {
        background: white;
    }
    
    /* Loading spinner */
    .autocomplete-loading {
        text-align: center;
        padding: 15px;
        color: #666;
    }
</style>

<script>
    const stocksData = {{ stocks_json|safe }};
    let currentKrediti = 0;
    let selectedClanId = null;
    let selectedClanName = '';
    let minusConfirmed = false;
    let searchTimeout = null;

    // Autocomplete funkcionalnost
    const searchInput = document.getElementById('clanSearchInput');
    const resultsDiv = document.getElementById('autocompleteResults');
    const clanIdInput = document.getElementById('clanIdInput');
    const selectedClanDiv = document.getElementById('selectedClan');
    const clearBtn = document.getElementById('clearClan');

    searchInput.addEventListener('input', function() {
        const query = this.value.trim();
        
        // Sakrij clear dugme ako je prazan input
        if (query === '') {
            clearBtn.style.display = 'none';
            resultsDiv.classList.remove('show');
            return;
        }
        
        clearBtn.style.display = 'block';
        
        // Debounce - ƒçekaj 300ms pre pretrage
        clearTimeout(searchTimeout);
        
        if (query.length < 2) {
            resultsDiv.innerHTML = '<div class="autocomplete-item no-results">Ukucaj minimum 2 slova...</div>';
            resultsDiv.classList.add('show');
            return;
        }
        
        searchTimeout = setTimeout(() => {
            // Prika≈æi loading
            resultsDiv.innerHTML = '<div class="autocomplete-loading">Pretraga...</div>';
            resultsDiv.classList.add('show');
            
            // AJAX pretraga
            fetch(`/sank/json/clanovi/?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.length === 0) {
                        resultsDiv.innerHTML = '<div class="autocomplete-item no-results">Nema rezultata</div>';
                    } else {
                        resultsDiv.innerHTML = data.map(clan => `
                            <div class="autocomplete-item" data-id="${clan.id}" data-name="${clan.ime_prezime}">
                                <strong>${clan.ime_prezime}</strong>
                            </div>
                        `).join('');
                        
                        // Dodaj event listener na svaki rezultat
                        resultsDiv.querySelectorAll('.autocomplete-item').forEach(item => {
                            item.addEventListener('click', function() {
                                selectClan(this.dataset.id, this.dataset.name);
                            });
                        });
                    }
                })
                .catch(error => {
                    console.error('Gre≈°ka pri pretrazi:', error);
                    resultsDiv.innerHTML = '<div class="autocomplete-item no-results">Gre≈°ka pri pretrazi</div>';
                });
        }, 300);
    });

    // Funkcija za izbor klijenta
    function selectClan(clanId, clanName) {
        selectedClanId = clanId;
        selectedClanName = clanName;
        
        // Postavi vrednosti
        clanIdInput.value = clanId;
        searchInput.value = clanName;
        
        // Sakrij rezultate
        resultsDiv.classList.remove('show');
        
        // Uƒçitaj kredite
        fetch(`/krediti/json/${clanId}/`)
            .then(r => r.json())
            .then(data => {
                currentKrediti = parseFloat(data.krediti_voda) || 0;
                
                // Prika≈æi info o klijentu
                document.getElementById('selectedClanName').textContent = clanName;
                document.getElementById('selectedClanKrediti').textContent = currentKrediti.toFixed(2);
                
                // Promeni boju ako je minus
                const alertDiv = selectedClanDiv.querySelector('.alert');
                if (currentKrediti < 0) {
                    alertDiv.classList.remove('alert-info');
                    alertDiv.classList.add('alert-danger');
                } else {
                    alertDiv.classList.remove('alert-danger');
                    alertDiv.classList.add('alert-info');
                }
                
                selectedClanDiv.style.display = 'block';
            })
            .catch(err => {
                console.error('Gre≈°ka pri uƒçitavanju kredita:', err);
            });
    }

    // Clear dugme
    clearBtn.addEventListener('click', function() {
        searchInput.value = '';
        clanIdInput.value = '';
        selectedClanId = null;
        selectedClanName = '';
        currentKrediti = 0;
        resultsDiv.classList.remove('show');
        selectedClanDiv.style.display = 'none';
        clearBtn.style.display = 'none';
        searchInput.focus();
    });

    // Zatvori rezultate ako se klikne van
    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !resultsDiv.contains(e.target)) {
            resultsDiv.classList.remove('show');
        }
    });

    // Automatsko raƒçunanje ukupne cene
    function updatePrice() {
        const stockSelect = document.getElementById('stockSelect');
        const kolicinaInput = document.getElementById('kolicinaInput');
        const ukupnaCenaDisplay = document.getElementById('ukupnaCenaDisplay');
        
        if (stockSelect && kolicinaInput) {
            const selectedOption = stockSelect.options[stockSelect.selectedIndex];
            const cena = parseFloat(selectedOption.dataset.cena) || 0;
            const kolicina = parseInt(kolicinaInput.value) || 0;
            const ukupnaCena = cena * kolicina;
            
            ukupnaCenaDisplay.value = ukupnaCena.toFixed(2);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        // Event listeners za automatsko raƒçunanje
        document.getElementById('stockSelect').addEventListener('change', updatePrice);
        document.getElementById('kolicinaInput').addEventListener('input', updatePrice);

        // Submit forma sa proverom minusa
        const form = document.getElementById('saleForm');
        form.addEventListener('submit', function(e) {
            if (minusConfirmed) {
                return; // Dozvoli submit
            }

            e.preventDefault(); // Zaustavi submit
            
            const stockSelect = document.getElementById('stockSelect');
            const kolicinaInput = document.getElementById('kolicinaInput');
            
            if (!selectedClanId) {
                alert('Molimo izaberite klijenta!');
                searchInput.focus();
                return;
            }
            
            const selectedOption = stockSelect.options[stockSelect.selectedIndex];
            const cena = parseFloat(selectedOption.dataset.cena) || 0;
            const kolicina = parseInt(kolicinaInput.value) || 0;
            const ukupnaCena = cena * kolicina;
            
            if (ukupnaCena <= 0) {
                alert('Molimo popunite sva polja!');
                return;
            }

            // Provera da li ƒáe uƒái u minus
            const noviKrediti = currentKrediti - ukupnaCena;
            
            if (noviKrediti < 0) {
                const minusAmount = Math.abs(noviKrediti).toFixed(2);
                
                document.getElementById('minusAmount').innerHTML = 
                    `<strong>${selectedClanName}</strong> ƒáe uƒái u minus: <span class="text-danger">-${minusAmount} EUR</span>`;
                
                const modal = new bootstrap.Modal(document.getElementById('minusModal'));
                modal.show();
                
                document.getElementById('confirmMinus').onclick = () => {
                    minusConfirmed = true;
                    modal.hide();
                    form.submit();
                };
            } else {
                form.submit();
            }
        });
    });
</script>
{% endblock %}
